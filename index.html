<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Audit Energetico - Relazione</title>

  <!-- ATECO map (stessa cartella) -->
  <script src="ateco_map.js"></script>

  <!-- Chart.js + datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- Export DOCX -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.5/pizzip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/docxtemplater/3.44.0/docxtemplater.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

  <style>
    :root { --b:#ddd; --bg:#fafafa; --txt:#111; --muted:#666; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:var(--txt); background:var(--bg); }
    header { padding:16px 20px; border-bottom:1px solid var(--b); background:#fff; }
    header .sub { color:var(--muted); font-size:12px; margin-top:4px; }
    .wrap { display:grid; grid-template-columns: 460px 1fr; gap:16px; padding:16px; align-items:start; }
    .panel { background:#fff; border:1px solid var(--b); border-radius:14px; padding:14px; }
    .panel h2 { margin:0 0 10px; font-size:15px; }

    label { display:block; font-size:12px; margin:10px 0 6px; color:#333; }
    input, select, textarea {
      width:100%; box-sizing:border-box; padding:10px;
      border:1px solid #ccc; border-radius:10px; background:#fff;
      font-size:14px;
    }
    textarea { resize: vertical; min-height: 90px; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .btns { display:flex; gap:10px; margin-top:12px; flex-wrap:wrap; }
    button { padding:10px 12px; border-radius:10px; cursor:pointer; border:1px solid #ccc; background:#fff; }
    button.primary { background:#111; color:#fff; border-color:#111; }
    .note { color:var(--muted); font-size:12px; margin-top:10px; line-height:1.35; }
    .hr { border:0; border-top:1px solid #eee; margin: 14px 0; }

    /* Documento preview (stile “Word-like”) */
    .doc { max-width: 1050px; margin: 0 auto; padding: 10px 18px 40px; background:#fff; border:1px solid #eee; border-radius:14px; }
    .doc h1 { font-size:22px; margin: 8px 0 12px; text-align:left; }
    .doc h2 { font-size:16px; margin: 18px 0 8px; }
    .doc p { font-size:13px; line-height:1.45; margin: 0 0 10px; }
    .muted { color:var(--muted); font-size:12px; }

    table { width:100%; border-collapse: collapse; font-size:13px; margin: 8px 0 12px; }
    th, td { border:1px solid #ddd; padding:8px; vertical-align: top; }
    th { background:#f6f6f6; text-align:left; }
    .center { text-align:center; }
    .right { text-align:right; }

    /* Interventi - form */
    .intervForm { border:1px solid #eee; border-radius:12px; padding:10px; }
    .iRow { display:grid; grid-template-columns: 1.2fr 0.9fr 0.9fr 0.9fr; gap:10px; margin-top:10px; }
    .iRow:first-child { margin-top:0; }
    .inlineChk { display:flex; align-items:center; gap:8px; padding:10px; border:1px solid #ccc; border-radius:10px; background:#fff; height: 42px; box-sizing:border-box; }
    .inlineChk input { width:auto; }

    /* Charts */
    .chartCard { border:1px solid #eee; border-radius:14px; padding:12px; background:#fff; margin: 8px 0 12px; }
    .chartTitle { font-size:22px; font-weight:800; text-align:center; margin: 6px 0 8px; }
    .chartWrap { position:relative; width:100%; }
    .chartWrap.donut { max-width: 560px; margin: 0 auto; }
    .charts2 { display:grid; grid-template-columns: 2fr 1fr; gap: 14px; align-items:start; }
    @media (max-width: 980px) {
      .wrap { grid-template-columns: 1fr; }
      .charts2 { grid-template-columns: 1fr; }
      .iRow { grid-template-columns: 1fr; }
    }

    /* Print */
    @media print {
      header, .panel.form { display:none; }
      body { background:#fff; }
      .wrap { padding:0; }
      .panel.preview { border:0; padding:0; }
      .doc { max-width:none; border:0; border-radius:0; padding:0 10mm; }
      .chartCard { page-break-inside: avoid; }
      canvas { page-break-inside: avoid; }
      table { page-break-inside: avoid; }
    }
  </style>
</head>

<body>
<header>
  <div><strong>Generatore Audit Energetico</strong></div>
  <div class="sub">Template HTML strutturato come il Word (paragrafi + tabelle) • ATECO+Anno→descrizione • Interventi standard • Grafici • Export Word</div>
</header>

<div class="wrap">
  <!-- FORM -->
  <section class="panel form" id="formPanel">
    <h2>Dati base</h2>

    <label>Società ({{azienda}})</label>
    <input id="azienda" placeholder="Es. ABC S.r.l." />

    <div class="row">
      <div>
        <label>Data ({{data}})</label>
        <input id="data" type="date" />
      </div>
      <div>
        <label>Indirizzo del sito ({{indirizzo}})</label>
        <input id="indirizzo" placeholder="Via..., Città" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Codice ATECO ({{ateco}})</label>
        <input id="ateco" placeholder="Es. 80.10.00" />
      </div>
      <div>
        <label>Anno ATECO</label>
        <select id="atecoAnno">
          <option value="2007">2007</option>
          <option value="2025">2025</option>
        </select>
      </div>
    </div>

    <label>Descrizione ATECO ({{descrizioneateco}})</label>
    <input id="descrizioneateco" placeholder="Compilata automaticamente" />

    <hr class="hr"/>

    <h2>Dati generali</h2>
    <div class="row">
      <div>
        <label>Superficie stabilimento [m²] ({{superficie}})</label>
        <input id="superficie" type="number" step="1" />
      </div>
      <div>
        <label>Numero linee produttive ({{linee}})</label>
        <input id="linee" type="number" step="1" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Ore di funzionamento annue ({{ore}})</label>
        <input id="ore" type="number" step="1" />
      </div>
      <div>
        <label>Ambiente riscaldato ({{riscaldato}})</label>
        <select id="riscaldato">
          <option value="—">—</option>
          <option value="Sì">Sì</option>
          <option value="No">No</option>
        </select>
      </div>
    </div>

    <hr class="hr"/>

    <h2>Consumi annui</h2>
    <div class="row">
      <div>
        <label>Energia elettrica rete [kWh] ({{EErete}})</label>
        <input id="EErete" type="number" step="0.01" />
      </div>
      <div>
        <label>Energia elettrica FER [kWh] ({{EEfer}})</label>
        <input id="EEfer" type="number" step="0.01" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Consumo annuo gas [Smc] ({{gas}})</label>
        <input id="gas" type="number" step="0.01" />
      </div>
      <div>
        <label>Consumo annuo gasolio [l] ({{gasolio}})</label>
        <input id="gasolio" type="number" step="0.01" />
      </div>
    </div>

    <hr class="hr"/>

    <h2>Tariffe</h2>
    <div class="row">
      <div>
        <label>Tariffa energia elettrica [€/kWh] ({{PEE}})</label>
        <input id="PEE" type="number" step="0.0001" />
      </div>
      <div>
        <label>Tariffa gas [€/Smc] ({{Pgas}})</label>
        <input id="Pgas" type="number" step="0.0001" />
      </div>
    </div>
    <label>Tariffa gasolio [€/l] ({{Pgasolio}})</label>
    <input id="Pgasolio" type="number" step="0.0001" />

    <hr class="hr"/>

    <h2>Aree di intervento (standard)</h2>
    <div class="note">
      Selezioni solo <b>Efficienza</b>. La checkbox “Intervento consigliato” si spunta automaticamente per <b>Media</b> o <b>Bassa</b>.
      Il campo <b>Opportunità</b> si abilita solo se la checkbox è spuntata (altrimenti resta vuoto e non editabile).
    </div>

    <div class="intervForm" id="interventiForm"></div>

    <hr class="hr"/>

    <h2>Export</h2>
    <div class="btns">
      <button class="primary" id="btnPrint">Stampa / Salva PDF</button>
      <button id="btnReset">Reset</button>
    </div>

    <label style="margin-top:14px;">Carica template Word (.docx) per export</label>
    <input type="file" id="tplDocx" accept=".docx" />
    <div class="btns">
      <button id="btnWord">Esporta Word (.docx)</button>
    </div>
    <div class="note">
      In export Word passo anche <code>interventi</code> come array (utile se nel docx vuoi fare un loop).
    </div>
  </section>

  <!-- PREVIEW -->
  <section class="panel preview">
    <div class="doc" id="docRoot"></div>
  </section>
</div>

<script>
  // =========================
  // COLORI (come richiesto)
  // =========================
  const ENERGY_COL = { ee:"#7E57C2", gas:"#00E676", gasolio:"#0F5B6E" }; // viola / verde / petrolio
  const EFF_COL = { alta:"#8BD96B", media:"#FFC000", bassa:"#E8742B" };  // verde / giallo / arancio
  function rgba(hex, a){ const h=hex.replace("#",""); const r=parseInt(h.slice(0,2),16),g=parseInt(h.slice(2,4),16),b=parseInt(h.slice(4,6),16); return `rgba(${r},${g},${b},${a})`; }

  // =========================
  // INTERVENTI STANDARD (dal Word)
  // =========================
  const INTERVENTI_STANDARD = [
    { area:"Motori elettrici", tipo:"Elettrico" },
    { area:"Applicazione inverter", tipo:"Elettrico" },
    { area:"Aria compressa", tipo:"Elettrico" },
    { area:"Centrale termica", tipo:"Termico" },
    { area:"Centrale frigo", tipo:"Elettrico" },
    { area:"Uffici", tipo:"Elettrico" },
    { area:"Illuminazione", tipo:"Elettrico" },
    { area:"Fotovoltaico", tipo:"Elettrico" },
    { area:"Cogenerazione", tipo:"Elettrico / Termico" },
    { area:"Carrelli elevatori", tipo:"Elettrico" },
    { area:"Involucro edilizio", tipo:"Termico" },
    { area:"HVAC / UTA", tipo:"Elettrico" },
    { area:"Rete elettrica", tipo:"Elettrico" },
    { area:"Flotta aziendale", tipo:"Gasolio" },
    { area:"Monitoraggio", tipo:"Elettrico" },
    { area:"Altro", tipo:"" }
  ];

  // stato interventi: efficienza + opportunità (testo)
  const interventiState = INTERVENTI_STANDARD.map(() => ({ eff:"N.A.", intervento:false, opportunita:"" }));

  // =========================
  // TEMPLATE (strutturato come Word)
  // =========================
  const TEMPLATE = `
    <h1>AUDIT ENERGETICO</h1>

    <!-- Tabella intestazione (come Word) -->
    <table>
      <tbody>
        <tr>
          <td><b>Società:</b></td><td>{{azienda}}</td>
          <td><b>Data:</b></td><td>{{data}}</td>
        </tr>
        <tr>
          <td><b>Indirizzo del sito:</b></td><td colspan="3">{{indirizzo}}</td>
        </tr>
        <tr>
          <td><b>Codice ATECO:</b></td><td>{{ateco}}</td>
          <td><b>Descrizione ATECO:</b></td><td>{{descrizioneateco}}</td>
        </tr>
      </tbody>
    </table>

    <h2>Obiettivi dell'audit</h2>
    <p>
      L’audit ha come scopo principale l’analisi dei consumi energetici complessivi dell’azienda, con particolare attenzione alle aree e ai reparti che risultano più energivori.
      L’attività è volta a individuare inefficienze o sprechi, stimare potenziali risparmi energetici e fornire raccomandazioni operative e strategiche che possano aiutare l’azienda a ottimizzare l’uso dell’energia.
      Il focus si concentra su un sopralluogo generale e sull’identificazione di criticità evidenti.
    </p>

    <h2>Dati generali</h2>
    <p>
      Il check-up considera i principali dati energetici disponibili dell’azienda, tra cui la superficie dello stabilimento, il numero di linee produttive, il consumo annuo di elettricità e gas/metano,
      le ore di funzionamento e le tariffe energetiche applicate. Questi dati servono a fornire un quadro generale dell’impegno energetico dell’azienda e delle possibili aree di intervento.
      Eventuali informazioni aggiuntive, come il tipo di impianti utilizzati o le caratteristiche specifiche di alcuni reparti, vengono annotate durante il sopralluogo.
      L'output del presente report è prodotto sulla base di interviste al personale aziendale e analisi delle fatture dei fornitori di energia.
    </p>

    <!-- Tabella dati generali (come Word, 2 colonne) -->
    <table>
      <tbody>
        <tr><td>Superficie stabilimento [m2]:</td><td class="right">{{superficie}}</td></tr>
        <tr><td>Numero linee produttive:</td><td class="right">{{linee}}</td></tr>
        <tr><td>Ore di funzionamento annue:</td><td class="right">{{ore}}</td></tr>
        <tr><td>Energia elettrica rete [kWh]:</td><td class="right">{{EErete}}</td></tr>
        <tr><td>Energia elettrica FER [kWh]:</td><td class="right">{{EEfer}}</td></tr>
        <tr><td>Consumo annuo gas [Smc]:</td><td class="right">{{gas}}</td></tr>
        <tr><td>Consumo annuo gasolio [l]:</td><td class="right">{{gasolio}}</td></tr>
        <tr><td>Tariffa energetica [€/kWh]:</td><td class="right">{{PEE}}</td></tr>
        <tr><td>Tariffa energetica [€/Smc]:</td><td class="right">{{Pgas}}</td></tr>
        <tr><td>Tariffa energetica [€/l]:</td><td class="right">{{Pgasolio}}</td></tr>
        <tr><td>Ambiente di produzione riscaldato:</td><td class="right">{{riscaldato}}</td></tr>
      </tbody>
    </table>

    <h2>Metodologia</h2>
    <p>
      L’approccio adottato per il check-up energetico prevede la raccolta dei dati disponibili, l’osservazione diretta delle utenze principali (elettricità, gas, aria compressa, acqua e combustibili)
      e l’individuazione di perdite o inefficienze evidenti. A differenza della diagnosi energetica, che è un’analisi approfondita con misurazioni dettagliate e che richiede diversi giorni per la realizzazione,
      l'audit energetico si presenta come un'indagine orientata a evidenziare criticità e a sondare le opportunità di miglioramento.
      Gli indicatori energetici principali, come kWh/m² o kWh per unità prodotta, vengono calcolati utilizzando dati di consumo storici e rilevazioni semplificate durante il sopralluogo.
    </p>

    <h2>Sintesi dei consumi</h2>
    <p>
      I consumi energetici dell’azienda sono stati valutati complessivamente e suddivisi per tipologia: elettricità, gas e gasolio.
      Per ogni voce sono riportati il consumo annuo stimato, la percentuale sul totale, il costo energetico.
      I vettori energetici prelevati dalla rete (fonti tradizionali) che concorrono al consumo di energia primaria sono stati trattati separatamente rispetto ad eventuali consumi associati a fonti rinnovabili.
      Lo scopo di questa sintesi è fornire una visione immediata delle aree più critiche e dei margini di miglioramento.
    </p>

    <!-- Tabella consumi tradizionali (come Word, 7 colonne) -->
    <table>
      <thead>
        <tr>
          <th>Consumi tradizionali</th>
          <th class="center">kWh</th>
          <th class="center">Smc</th>
          <th class="center">litri</th>
          <th class="center">tep (*)</th>
          <th class="center">tep [%]</th>
          <th class="center">conversione<br/>in tep</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>Energia Elettrica rete</td>
          <td class="right">{{EErete}}</td>
          <td></td><td></td>
          <td class="right">{{Eerete_tep}}</td>
          <td class="right">{{perEE}}</td>
          <td class="center">0,187 x 10<sup>-3</sup></td>
        </tr>
        <tr>
          <td>Gas</td>
          <td></td>
          <td class="right">{{gas}}</td>
          <td></td>
          <td class="right">{{gas_tep}}</td>
          <td class="right">{{pergas}}</td>
          <td class="center">0,825 x 10<sup>-3</sup></td>
        </tr>
        <tr>
          <td>Gasolio</td>
          <td></td><td></td>
          <td class="right">{{gasolio}}</td>
          <td class="right">{{gasolio_tep}}</td>
          <td class="right">{{pergasolio}}</td>
          <td class="center">0,867 x 10<sup>-3</sup></td>
        </tr>
        <tr>
          <th>TOTALE</th>
          <th class="right">{{EErete}}</th>
          <th class="right">{{gas}}</th>
          <th class="right">{{gasolio}}</th>
          <th class="right">{{tot_tep}}</th>
          <th class="right">100%</th>
          <th></th>
        </tr>
      </tbody>
    </table>

    <p class="muted">(*) Il tep (tonnellata equivalente di petrolio) rappresenta la quantità di energia rilasciata dalla combustione di una tonnellata di petrolio grezzo.</p>
    <p class="muted">(**) L'energia FER deriva da Fonti Energetiche Rinnovabili, come impianti fotovoltaici o idroelettrici.</p>

    <h2>GRAFICI</h2>
    <p>Di seguito si riportano i costi associati ai consumi energetici:</p>

    <!-- Tabella costi (come Word) -->
    <table>
      <thead>
        <tr><th>Consumi</th><th class="center">Prezzo</th><th class="center">Quantità</th><th class="center">Costo energia</th></tr>
      </thead>
      <tbody>
        <tr><td>Energia Elettrica</td><td class="right">{{PEE}}</td><td class="right">{{EErete}}</td><td class="right">{{costoEE}} €</td></tr>
        <tr><td>Gas</td><td class="right">{{Pgas}}</td><td class="right">{{gas}}</td><td class="right">{{costogas}} €</td></tr>
        <tr><td>Gasolio</td><td class="right">{{Pgasolio}}</td><td class="right">{{gasolio}}</td><td class="right">{{costogasolio}} €</td></tr>
        <tr><th>TOTALE</th><th></th><th></th><th class="right">{{costotot}} €</th></tr>
      </tbody>
    </table>

    <h3>GRAFICI COSTI</h3>
    <div class="chartCard">
      <div class="chartTitle">Confronto costi vs consumi energetici</div>
      <div class="chartWrap donut">
        <canvas id="chartCostiConsumi" height="320"></canvas>
      </div>
      <p class="muted" style="text-align:center;margin:8px 0 0;">Anello esterno: consumi [tep] — Anello interno: costi [€]</p>
    </div>

    <p>
      Di seguito si riportano alcuni KPI (key performance indicators) di carattere generale, utili per confronti a distanza di tempo con una baseline, obiettivi o con valori di benchmark.
      Il confronto di questi dati è da attenzionare poichè sono strettamente legati alla performance del sistema: creando appositi indicatori, anche di maggior dettaglio e specificità,
      e monitorandoli sistematicamente nel tempo è possibile prendere decisioni strategiche e valutare l'efficienza dell'azienda.
    </p>

    <!-- Tabella KPI (struttura come Word, 5 colonne) -->
    <table>
      <thead>
        <tr>
          <th>Energia elettrica (inclusa FER) [kWh]</th>
          <th class="center">Superficie [m2]</th>
          <th class="center"></th>
          <th class="center">KPI 1:<br/>kWh/m2</th>
          <th class="center">Benchmark:<br/>kWh/m2</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td class="right">{{EEtot}}</td>
          <td class="right">{{superficie}}</td>
          <td class="center"></td>
          <td class="right">{{kpi1}}</td>
          <td class="right">{{bench1}}</td>
        </tr>
      </tbody>
    </table>

    <h2>Analisi settoriale e opportunità</h2>
    <p>
      Durante il sopralluogo sono stati osservati i principali reparti dell’azienda, annotando il tipo di consumo energetico predominante, l’efficienza percepita e le note rilevanti per ciascun reparto.
      L’analisi si basa su osservazioni visive e dati generali, finalizzata a evidenziare i reparti dove l’energia viene maggiormente utilizzata o dispersa, e dove eventuali interventi di ottimizzazione possono portare benefici immediati.
    </p>
    <p>
      Il check-up include l’individuazione delle perdite o degli sprechi evidenti, come ad esempio: perdite di aria compressa, consumi elettrici eccessivi dovuti a cablaggi o motori inefficienti,
      dispersioni termiche dagli impianti di riscaldamento e raffreddamento.
    </p>

    <!-- Tabella aree di intervento (come Word, ma resa pulita: 5 colonne logiche) -->
    <h3>GRAFICI EFFICIENZA</h3>
    <div class="charts2">
      <div class="chartCard">
        <div class="chartTitle">Efficienza rilevata</div>
        <div class="chartWrap">
          <canvas id="chartEffBar" height="260"></canvas>
        </div>
      </div>
      <div class="chartCard">
        <div class="chartTitle">&nbsp;</div>
        <div class="chartWrap donut">
          <canvas id="chartEffDonut" height="260"></canvas>
        </div>
      </div>
    </div>

    <h2>Aree di intervento</h2>
    <table>
      <thead>
        <tr>
          <th>Aree di intervento</th>
          <th>Tipo</th>
          <th class="center">Efficienza</th>
          <th class="center">Intervento consigliato</th>
          <th>Opportunità</th>
        </tr>
      </thead>
      <tbody>
        {{INTERVENTI_ROWS}}
      </tbody>
    </table>
  `;

  // =========================
  // Utils
  // =========================
  function safe(s) {
    return String(s ?? "")
      .replaceAll("&", "&amp;").replaceAll("<", "&lt;").replaceAll(">", "&gt;")
      .replaceAll('"', "&quot;").replaceAll("'", "&#039;");
  }
  function num(v){ const n = Number(String(v ?? "").replace(",", ".")); return Number.isFinite(n) ? n : 0; }
  function fmtInt(n){ return Number(n).toLocaleString("it-IT", { maximumFractionDigits: 0 }); }
  function fmt1(n){ return Number(n).toLocaleString("it-IT", { minimumFractionDigits: 1, maximumFractionDigits: 1 }); }
  function fmt2(n){ return Number(n).toLocaleString("it-IT", { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
  function fmtPct0(n){ return `${Math.round(n)}%`; }

  function applyTemplate(html, data) {
    return html.replace(/\{\{([^}]+)\}\}/g, (_, key) => {
      const k = key.trim();
      return (k in data) ? String(data[k]) : "";
    });
  }

  // =========================
  // ATECO lookup
  // =========================
  function normAteco(code) { return String(code ?? "").trim().replace(",", "."); }
  function updateDescrizioneAteco() {
    const codice = normAteco(document.getElementById("ateco").value);
    const anno = String(document.getElementById("atecoAnno").value || "").trim();
    const out = document.getElementById("descrizioneateco");
    const key = `${anno}|${codice}`;
    out.value = (window.ATECO_MAP && window.ATECO_MAP[key]) ? window.ATECO_MAP[key] : "";
  }

  // =========================
  // Interventi form render (standard)
  // =========================
  const interventiForm = document.getElementById("interventiForm");

  function computeInterventoAuto(eff) {
    return (eff === "Media" || eff === "Bassa");
  }

  function renderInterventiForm() {
    interventiForm.innerHTML = "";
    INTERVENTI_STANDARD.forEach((it, idx) => {
      const st = interventiState[idx];

      const wrap = document.createElement("div");
      wrap.className = "iRow";
      wrap.innerHTML = `
        <div>
          <label style="margin-top:0;">Area</label>
          <input value="${safe(it.area)}" disabled />
        </div>
        <div>
          <label style="margin-top:0;">Tipo</label>
          <input value="${safe(it.tipo)}" disabled />
        </div>
        <div>
          <label style="margin-top:0;">Efficienza</label>
          <select data-eff="${idx}">
            <option ${st.eff==="Alta"?"selected":""} value="Alta">Alta</option>
            <option ${st.eff==="Media"?"selected":""} value="Media">Media</option>
            <option ${st.eff==="Bassa"?"selected":""} value="Bassa">Bassa</option>
            <option ${st.eff==="N.A."?"selected":""} value="N.A.">N.A.</option>
          </select>
        </div>
        <div>
          <label style="margin-top:0;">Intervento</label>
          <div class="inlineChk">
            <input type="checkbox" data-chk="${idx}" ${st.intervento ? "checked" : ""} disabled />
            <span>Consigliato</span>
          </div>
        </div>
        <div style="grid-column:1/-1;">
          <label>Opportunità</label>
          <textarea data-op="${idx}" placeholder="Scrivi qui..." ${st.intervento ? "" : "disabled"}>${safe(st.opportunita)}</textarea>
        </div>
      `;
      interventiForm.appendChild(wrap);

      // events
      wrap.querySelector(`select[data-eff="${idx}"]`).addEventListener("change", (e) => {
        const eff = e.target.value;
        st.eff = eff;

        // checkbox auto
        st.intervento = computeInterventoAuto(eff);

        // se non attivo, svuota e disabilita textarea
        if (!st.intervento) st.opportunita = "";

        renderInterventiForm();
        render();
      });

      wrap.querySelector(`textarea[data-op="${idx}"]`).addEventListener("input", (e) => {
        st.opportunita = e.target.value;
        render();
      });
    });
  }

  // =========================
  // Calcoli energetici + costi + KPI + stats efficienza
  // =========================
  function compute(input) {
    const EErete_kWh = num(input.EErete);
    const EEfer_kWh = num(input.EEfer);
    const gas_smc = num(input.gas);
    const gasolio_l = num(input.gasolio);

    const PEE = num(input.PEE);
    const Pgas = num(input.Pgas);
    const Pgasolio = num(input.Pgasolio);

    const fEE = 0.187e-3;
    const fGas = 0.825e-3;
    const fGasolio = 0.867e-3;

    const Eerete_tep = EErete_kWh * fEE;
    const gas_tep = gas_smc * fGas;
    const gasolio_tep = gasolio_l * fGasolio;

    const tot_tep = Eerete_tep + gas_tep + gasolio_tep;
    const denom = tot_tep > 0 ? tot_tep : 1;

    const perEE = (Eerete_tep / denom) * 100;
    const pergas = (gas_tep / denom) * 100;
    const pergasolio = (gasolio_tep / denom) * 100;

    const costoEE = EErete_kWh * PEE;
    const costogas = gas_smc * Pgas;
    const costogasolio = gasolio_l * Pgasolio;
    const costotot = costoEE + costogas + costogasolio;

    // KPI table (nel Word era lasciata generica: qui metto un default sensato)
    const EEtot = EErete_kWh + EEfer_kWh;
    const superficie = num(input.superficie);
    const kpi1 = superficie > 0 ? (EEtot / superficie) : 0;
    const bench1 = 0; // se vuoi, lo rendiamo editabile

    // Efficienza (N.A. esclusi)
    const counts = { Alta:0, Media:0, Bassa:0, "N.A.":0 };
    interventiState.forEach(s => { counts[s.eff] = (counts[s.eff] ?? 0) + 1; });
    const valid = counts.Alta + counts.Media + counts.Bassa;

    return {
      ...input,

      // formattazioni principali
      azienda: input.azienda || "—",
      data: input.data || new Date().toISOString().slice(0,10),
      indirizzo: input.indirizzo || "—",
      ateco: input.ateco || "—",
      descrizioneateco: input.descrizioneateco || "—",
      riscaldato: input.riscaldato || "—",

      superficie: input.superficie || "—",
      linee: input.linee || "—",
      ore: input.ore || "—",

      EErete: fmtInt(EErete_kWh),
      EEfer: fmtInt(EEfer_kWh),
      gas: fmtInt(gas_smc),
      gasolio: fmtInt(gasolio_l),

      PEE: input.PEE ? fmt2(PEE) : "—",
      Pgas: input.Pgas ? fmt2(Pgas) : "—",
      Pgasolio: input.Pgasolio ? fmt2(Pgasolio) : "—",

      Eerete_tep: fmt1(Eerete_tep),
      gas_tep: fmt1(gas_tep),
      gasolio_tep: fmt1(gasolio_tep),
      tot_tep: fmt1(tot_tep),

      perEE: fmtPct0(perEE),
      pergas: fmtPct0(pergas),
      pergasolio: fmtPct0(pergasolio),

      costoEE: fmt2(costoEE),
      costogas: fmt2(costogas),
      costogasolio: fmt2(costogasolio),
      costotot: fmt2(costotot),

      EEtot: fmtInt(EEtot),
      kpi1: fmt2(kpi1),
      bench1: bench1 ? fmt2(bench1) : "—",

      _raw: {
        Eerete_tep, gas_tep, gasolio_tep,
        costoEE, costogas, costogasolio,
        effCounts: counts, effValid: valid
      }
    };
  }

  // =========================
  // Render tabella interventi (preview)
  // =========================
  function buildInterventiRowsHTML() {
    return INTERVENTI_STANDARD.map((it, idx) => {
      const st = interventiState[idx];
      const opp = st.intervento ? safe(st.opportunita).replaceAll("\n","<br/>") : "";
      const chk = st.intervento ? "☑" : "☐";
      return `
        <tr>
          <td>${safe(it.area)}</td>
          <td>${safe(it.tipo)}</td>
          <td class="center">${safe(st.eff)}</td>
          <td class="center">${chk}</td>
          <td>${opp}</td>
        </tr>
      `;
    }).join("");
  }

  // =========================
  // Charts
  // =========================
  Chart.register(ChartDataLabels);
  let chartCostiConsumi=null, chartEffBar=null, chartEffDonut=null;

  function destroyCharts(){
    if(chartCostiConsumi){ chartCostiConsumi.destroy(); chartCostiConsumi=null; }
    if(chartEffBar){ chartEffBar.destroy(); chartEffBar=null; }
    if(chartEffDonut){ chartEffDonut.destroy(); chartEffDonut=null; }
  }

  function renderCharts(calc){
    const r = calc._raw;

    // COSTI vs CONSUMI (doppio anello)
    const cEl = document.getElementById("chartCostiConsumi");
    if (cEl){
      const labels = ["Energia Elettrica", "Gas", "Gasolio"];
      const outer = [r.Eerete_tep, r.gas_tep, r.gasolio_tep];
      const inner = [r.costoEE, r.costogas, r.costogasolio];

      chartCostiConsumi = new Chart(cEl, {
        type:"doughnut",
        data:{
          labels,
          datasets:[
            { // esterno consumi tep (chiaro)
              label:"Consumi [tep]",
              data: outer,
              backgroundColor:[rgba(ENERGY_COL.ee,0.35), rgba(ENERGY_COL.gas,0.35), rgba(ENERGY_COL.gasolio,0.35)],
              borderColor:"#fff", borderWidth:6, radius:"100%", cutout:"70%"
            },
            { // interno costi € (pieno)
              label:"Costi [€]",
              data: inner,
              backgroundColor:[ENERGY_COL.ee, ENERGY_COL.gas, ENERGY_COL.gasolio],
              borderColor:"#fff", borderWidth:6, radius:"70%", cutout:"45%"
            }
          ]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          rotation:-90*(Math.PI/180),
          plugins:{
            legend:{display:false},
            tooltip:{
              callbacks:{
                label:(ctx)=>{
                  const v = ctx.parsed || 0;
                  const isTep = ctx.datasetIndex===0;
                  return isTep ? `${ctx.label}: ${fmt1(v)} tep` : `${ctx.label}: ${fmt2(v)} €`;
                }
              }
            },
            datalabels:{
              display:(ctx)=>ctx.datasetIndex===0,
              color:"#777",
              font:{size:11, weight:"600"},
              anchor:"end", align:"end", offset:10,
              formatter:(value, ctx)=>{
                if(!value || value<=0) return "";
                const lab = ctx.chart.data.labels[ctx.dataIndex];
                return [`Consumi [tep]`, lab, fmt1(value)];
              }
            }
          }
        }
      });
    }

    // Efficienza (N.A. esclusi)
    const counts = r.effCounts || {Alta:0, Media:0, Bassa:0, "N.A.":0};
    const alta=counts.Alta||0, media=counts.Media||0, bassa=counts.Bassa||0;
    const valid = alta+media+bassa;

    const bEl = document.getElementById("chartEffBar");
    if(bEl){
      chartEffBar = new Chart(bEl,{
        type:"bar",
        data:{
          labels:["Bassa","Media","Alta"],
          datasets:[{
            data:[bassa, media, alta],
            backgroundColor:[EFF_COL.bassa, EFF_COL.media, EFF_COL.alta],
            borderRadius:6
          }]
        },
        options:{
          indexAxis:"y",
          responsive:true, maintainAspectRatio:false,
          plugins:{
            legend:{display:false},
            datalabels:{
              color:"#111",
              anchor:"end", align:"right", offset:6,
              font:{size:12, weight:"700"},
              formatter:(v)=>String(v)
            }
          },
          scales:{
            x:{beginAtZero:true, grid:{color:"#E6E6E6"}, ticks:{precision:0}},
            y:{grid:{display:false}}
          }
        }
      });
    }

    const dEl = document.getElementById("chartEffDonut");
    if(dEl){
      chartEffDonut = new Chart(dEl,{
        type:"doughnut",
        data:{
          labels:["Bassa","Media","Alta"],
          datasets:[{
            data:[bassa, media, alta],
            backgroundColor:[EFF_COL.bassa, EFF_COL.media, EFF_COL.alta],
            borderColor:"#fff", borderWidth:6
          }]
        },
        options:{
          responsive:true, maintainAspectRatio:false,
          cutout:"60%",
          rotation:-90*(Math.PI/180),
          plugins:{
            legend:{display:false},
            datalabels:{
              color:"#111",
              font:{size:11, weight:"700"},
              formatter:(v, ctx)=>{
                if(!valid || v<=0) return "";
                const pct = Math.round((v/valid)*100);
                return [`${ctx.chart.data.labels[ctx.dataIndex]}`, `${pct}%`];
              }
            }
          }
        }
      });
    }
  }

  // =========================
  // getFormData + render
  // =========================
  const docRoot = document.getElementById("docRoot");

  function getFormData(){
    return {
      azienda: safe(document.getElementById("azienda").value),
      data: safe(document.getElementById("data").value) || new Date().toISOString().slice(0,10),
      indirizzo: safe(document.getElementById("indirizzo").value),

      ateco: safe(document.getElementById("ateco").value),
      atecoAnno: safe(document.getElementById("atecoAnno").value),
      descrizioneateco: safe(document.getElementById("descrizioneateco").value),

      superficie: safe(document.getElementById("superficie").value),
      linee: safe(document.getElementById("linee").value),
      ore: safe(document.getElementById("ore").value),
      riscaldato: safe(document.getElementById("riscaldato").value),

      EErete: safe(document.getElementById("EErete").value),
      EEfer: safe(document.getElementById("EEfer").value),
      gas: safe(document.getElementById("gas").value),
      gasolio: safe(document.getElementById("gasolio").value),

      PEE: safe(document.getElementById("PEE").value),
      Pgas: safe(document.getElementById("Pgas").value),
      Pgasolio: safe(document.getElementById("Pgasolio").value),
    };
  }

  function render(){
    const input = getFormData();
    const calc = compute(input);

    // inserisco righe interventi nel template
    const html = TEMPLATE.replace("{{INTERVENTI_ROWS}}", buildInterventiRowsHTML());
    docRoot.innerHTML = applyTemplate(html, calc);

    destroyCharts();
    renderCharts(calc);
  }

  // =========================
  // Export Word
  // =========================
  async function exportWordDocx(){
    const fileInput = document.getElementById("tplDocx");
    if(!fileInput.files || !fileInput.files[0]){
      alert("Carica prima il template Word (.docx).");
      return;
    }

    const input = getFormData();
    const calc = compute(input);

    // preparo array interventi per eventuale loop nel docx
    const interventi = INTERVENTI_STANDARD.map((it, idx) => {
      const st = interventiState[idx];
      return {
        area: it.area,
        tipo: it.tipo,
        efficienza: st.eff,
        intervento: st.intervento ? "Sì" : "No",
        intervento_box: st.intervento ? "☑" : "☐",
        opportunita: st.intervento ? st.opportunita : ""
      };
    });

    const dataForDocx = { ...calc, interventi };

    const buf = await fileInput.files[0].arrayBuffer();
    const zip = new PizZip(buf);
    const doc = new docxtemplater(zip, { paragraphLoop:true, linebreaks:true });

    doc.setData(dataForDocx);

    try { doc.render(); }
    catch(err){
      console.error(err);
      alert("Errore nel template Word: spesso i placeholder {{...}} sono spezzati da formattazione.");
      return;
    }

    const out = doc.getZip().generate({
      type:"blob",
      mimeType:"application/vnd.openxmlformats-officedocument.wordprocessingml.document"
    });

    const name = (input.azienda || "relazione").replace(/[^\w\-]+/g, "_");
    saveAs(out, `${name}_audit.docx`);
  }

  // =========================
  // Eventi UI
  // =========================
  document.querySelectorAll("#formPanel input, #formPanel textarea, #formPanel select")
    .forEach(el => el.addEventListener("input", () => {
      if(el.id==="ateco" || el.id==="atecoAnno") updateDescrizioneAteco();
      render();
    }));

  document.getElementById("ateco").addEventListener("input", () => { updateDescrizioneAteco(); render(); });
  document.getElementById("atecoAnno").addEventListener("change", () => { updateDescrizioneAteco(); render(); });

  document.getElementById("btnPrint").addEventListener("click", () => window.print());
  document.getElementById("btnWord").addEventListener("click", exportWordDocx);

  document.getElementById("btnReset").addEventListener("click", () => {
    const ids = ["azienda","data","indirizzo","ateco","descrizioneateco","superficie","linee","ore","EErete","EEfer","gas","gasolio","PEE","Pgas","Pgasolio"];
    ids.forEach(id => document.getElementById(id).value = "");
    document.getElementById("atecoAnno").value = "2007";
    document.getElementById("riscaldato").value = "—";

    interventiState.forEach(s => { s.eff="N.A."; s.intervento=false; s.opportunita=""; });
    renderInterventiForm();
    updateDescrizioneAteco();
    render();
  });

  // init
  renderInterventiForm();
  updateDescrizioneAteco();
  render();
</script>
</body>
</html>